---
- name: "CAT I | RHEL-07-010010 | The Red Hat Enterprise Linux operating system must be configured so that the file permissions, ownership, and group membership of system files and commands match the vendor values."
  block:
    - name: Check for packages with incorrect permissions
      shell: |
        ( for i in `rpm -Va --nodeps --nosignature --nofiledigest --nosize --nomtime --nordev --nocaps --nolinkto --nouser --nogroup | egrep -i '^\.[M|U|G|.]{8}' | cut -d " " -f4,5`; do rpm -qf $i;done )
      args:
        warn: false
      register: packages_with_incorrect_permissions
      failed_when: packages_with_incorrect_permissions.rc > 1
      changed_when: false
    - name: Correct package ownership and permissions
      shell: |
        ( rpm --setugids "{{ item }}"; rpm --setperms "{{ item }}" )
      args:
        warn: false
      with_items: '{{ packages_with_incorrect_permissions.stdout_lines }}'
      when:
        - (packages_with_incorrect_permissions.stdout_lines | length > 0)
  tags:
      - CAT-I
      - RHEL-07-010010

- name: "CAT I | RHEL-07-010020 | The Red Hat Enterprise Linux operating system must be configured so that the cryptographic hash of system files and commands matches vendor values."
  block:
    - name: Check for packages with incorrect cryptographic integrity
      shell: |
        ( for i in `rpm -Va --noconfig --nolinkto --nosize --nouser --nogroup --nomtime --nomode --nodigest --nosignature | egrep -i '^..5' | cut -d " " -f4,5`; do rpm -qf $i;done )
      args:
        warn: false
      register: packages_with_incorrect_crypto
      failed_when: packages_with_incorrect_crypto.rc > 1
      changed_when: false
    - name: Correct package cryptographic integrity
      shell: |
        ( yum reinstall -y {{ item }} )
      args:
        warn: false
      register: package_fix_crypto
      failed_when: package_fix_crypto.rc > 1
      with_items: '{{ packages_with_incorrect_crypto.stdout_lines }}'
      when:
        - (packages_with_incorrect_crypto.stdout_lines | length > 0)
  tags:
      - CAT-I
      - RHEL-07-010020

- name: "CAT II | RHEL-07-010030 | The Red Hat Enterprise Linux operating system must display the Standard Mandatory DoD Notice and Consent Banner before granting local or remote access to the system via a graphical user logon."
  block:
    - name: Check if the DoD banner is shown with a graphical logon
      shell: |
        if rpm -qa|grep -qs gnome; then
          currstatus=$(sed -n -r "/^\s*\[org\/gnome\/login-screen\]\s*$/,/^\s*\[/ s/^\s*banner-message-enable\s*=\s*(.*)$/\1/p" /etc/dconf/db/local.d/01-banner-message)
          if [[ "${currstatus}" == "true" ]]; then
            exit 0
          else
            exit 1
          fi
        else
          exit 0
        fi
      args:
        warn: false
      register: gui_banner_enable_check
      failed_when: gui_banner_enable_check.rc > 1
      changed_when: false
    - name: Enable banner on graphical logon
      shell: |
        filename="/etc/dconf/db/local.d/01-banner-message"
        section="\[org\/gnome\/login-screen\]"
        regsection="[org/gnome/login-screen]"
        varname="banner-message-enable"
        if [[ ! -f $filename ]] || sed -n "/^\s*${section}\s*$/q 1" $filename; then
            echo $regsection >> $filename
        fi
        sed -n -r "/^\s*${section}\s*$/,/^\s*\[/{/^\s*${varname}/q 10}" $filename
        if [[ $? -eq 10 ]]; then
            sed -i -r "/^\s*${section}\s*$/,/^\s*\[/ s/^(\s*${varname}\s*=\s*).*$/\1true/" $filename
        else
            sed -i "/^\s*${section}\s*$/a ${varname}=true" $filename
        fi
      args:
        warn: false
      when:
        - (gui_banner_enable_check.rc > 0)
  tags:
      - CAT-II
      - RHEL-07-010030

- name: "CAT II | RHEL-07-010040 | The Red Hat Enterprise Linux operating system must display the approved Standard Mandatory DoD Notice and Consent Banner before granting local or remote access to the system via a graphical user logon."
  block:
    - name: Check for the correct DoD banner
      shell: |
        regcorrectstatus="'{{ logon_banner | regex_replace('(?s)(?<!\\n)\\n(?!(\n|$))', '') }}'"
        if rpm -qa|grep -qs gnome; then
          currstatus=$(sed -n -r "/^\s*\[org\/gnome\/login-screen\]\s*$/,/^\s*\[/ s/^\s*banner-message-text\s*=\s*(.*)$/\1/p" /etc/dconf/db/local.d/01-banner-message)
          if [[ "${currstatus}" == "${regcorrectstatus}" ]]; then
            exit 0
          else
            exit 1
          fi
        else
          exit 0
        fi
      args:
        warn: false
      register: gui_banner_correct_check
      failed_when: gui_banner_correct_check.rc > 1
      changed_when: false
    - name: Correct banner text on graphical logon
      shell: |
        filename="/etc/dconf/db/local.d/01-banner-message"
        section="\[org\/gnome\/login-screen\]"
        regsection="[org/gnome/login-screen]"
        varname="banner-message-text"
        correctstatus="'{{ logon_banner | regex_replace('(?s)(?<!\\n)\\n(?!(\n|$))', '') | regex_replace('(\(|\)|\.)', '\\\1') | regex_replace('(\\n)', '\\\\\1') }}'"
        if [[ ! -f $filename ]] || sed -n "/^\s*${section}\s*$/q 1" $filename; then
          echo "${regsection}" >> $filename
        fi
        sed -n -r "/^\s*${section}\s*$/,/^\s*\[/{/^\s*${varname}/q 10}" $filename
        if [[ $? -eq 10 ]]; then
          sed -i -r "/^\s*${section}\s*$/,/^\s*\[/ s/^(\s*${varname}\s*=\s*).*$/\1${correctstatus}/" $filename
        else
          sed -i "/^\s*${section}\s*$/a ${varname}=${correctstatus}" $filename
        fi
      args:
        warn: false
      when:
        - (gui_banner_correct_check.rc > 0)
  tags:
      - CAT-II
      - RHEL-07-010040

- name: "CAT II | RHEL-07-010050 | The Red Hat Enterprise Linux operating system must display the Standard Mandatory DoD Notice and Consent Banner before granting local or remote access to the system via a command line user logon."
  block:
    - name: Check for DoD banner for console logon
      shell: |
        correctstatus=$(echo -e "{{ logon_banner }}")
        if [[ $correctstatus == $(cat /etc/issue) ]]; then
          exit 0
        else
          exit 1
        fi
      args:
        warn: false
      register: console_banner_check
      failed_when: console_banner_check.rc > 1
      changed_when: false
    - name: Correct console logon banner
      shell: |
        echo -e "{{ logon_banner }}" > /etc/issue
      args:
        warn: false
      when:
        - (console_banner_check.rc > 0)
  tags:
     - CAT-II
     - RHEL-07-010050

- name: "CAT II | RHEL-07-010060 | The Red Hat Enterprise Linux operating system must enable a user session lock until that user re-establishes access using established identification and authentication procedures."
  block:
    - name: Check for session lock
      shell: |
        if rpm -qa|grep -qs gnome; then
          currstatus=$(sed -n -r "/^\s*\[org\/gnome\/desktop\/screensaver\]\s*$/,/^\s*\[/ s/^\s*lock-enabled\s*=\s*(.*)$/\1/p" /etc/dconf/db/local.d/00-screensaver)
          if [[ "${currstatus}" == "true" ]]; then
            exit 0
          else
            exit 1
          fi
        else
          exit 0
        fi
      args:
        warn: false
      register: gui_lock_enable_check
      failed_when: gui_lock_enable_check.rc > 1
      changed_when: false
    - name: Correct session lock
      shell: |
        filename="/etc/dconf/db/local.d/00-screensaver"
        section="\[org\/gnome\/desktop\/screensaver\]"
        regsection="[org/gnome/desktop/screensaver]"
        varname="lock-enabled"
        if [[ ! -f $filename ]] || sed -n "/^\s*${section}\s*$/q 1" $filename; then
            echo $regsection >> $filename
        fi
        sed -n -r "/^\s*${section}\s*$/,/^\s*\[/{/^\s*${varname}/q 10}" $filename
        if [[ $? -eq 10 ]]; then
            sed -i -r "/^\s*${section}\s*$/,/^\s*\[/ s/^(\s*${varname}\s*=\s*).*$/\1true/" $filename
        else
            sed -i "/^\s*${section}\s*$/a ${varname}=true" $filename
        fi
        dconf update
      args:
        warn: false
      register: testing
      when:
        - (gui_lock_enable_check.rc > 0)
  tags:
     - CAT-II
     - RHEL-07-010060

- name: "CAT II | RHEL-07-010061 | The Red Hat Enterprise Linux operating system must uniquely identify and must authenticate users using multifactor authentication via a graphical user logon."
  block:
    - name: Check for smartcard login
      shell: |
        if rpm -qa|grep -qs gnome; then
          currstatus=$(sed -n -r "/^\s*\[org\/gnome\/login-screen\]\s*$/,/^\s*\[/ s/^\s*enable-smartcard-authentication\s*=\s*(.*)$/\1/p" /etc/dconf/db/local.d/00-defaults)
          if [[ "${currstatus}" == "true" ]]; then
            exit 0
          else
            exit 1
          fi
        else
          exit 0
        fi
      args:
        warn: false
      register: smartcard_enable_check
      failed_when: smartcard_enable_check.rc > 1
      changed_when: false
    - name: Correct smartcard login
      shell: |
        filename="/etc/dconf/db/local.d/00-defaults"
        section="\[org\/gnome\/login-screen\]"
        regsection="[org/gnome/login-screen]"
        varname="enable-smartcard-authentication"
        if [[ ! -f $filename ]] || sed -n "/^\s*${section}\s*$/q 1" $filename; then
            echo $regsection >> $filename
        fi
        sed -n -r "/^\s*${section}\s*$/,/^\s*\[/{/^\s*${varname}/q 10}" $filename
        if [[ $? -eq 10 ]]; then
            sed -i -r "/^\s*${section}\s*$/,/^\s*\[/ s/^(\s*${varname}\s*=\s*).*$/\1true/" $filename
        else
            sed -i "/^\s*${section}\s*$/a ${varname}=true" $filename
        fi
        dconf update
      args:
        warn: false
      when:
        - (smartcard_enable_check.rc > 0)
  tags:
     - CAT-II
     - RHEL-07-010061

- name: "CAT II | RHEL-07-010062 | The Red Hat Enterprise Linux operating system must prevent a user from overriding the screensaver lock-enabled setting for the graphical user interface."
  block:
    - name: Check for prevention of overriding lock setting
      shell: |
        if rpm -qa|grep -qs gnome; then
          grep -qsi "/org/gnome/desktop/screensaver/lock-enabled" /etc/dconf/db/local.d/locks/*
        fi
      args:
        warn: false
      register: lock_override_check
      failed_when: lock_override_check.rc > 2
      changed_when: false
    - name: Correct lock override prevention
      shell: |
        echo "/org/gnome/desktop/screensaver/lock-enabled" >> /etc/dconf/db/local.d/locks/session
      args:
        warn: false
      when:
        - (lock_override_check.rc > 0)
  tags:
      - CAT-II
      - RHEL-07-010062

- name: "CAT II | RHEL-07-010070 | The Red Hat Enterprise Linux operating system must initiate a screensaver after a 15-minute period of inactivity for graphical user interfaces."
  block:
    - name: Check for screensaver timeout
      shell: |
        if rpm -qa|grep -qs gnome; then
          currstatus=$(sed -n -r "/^\s*\[org\/gnome\/desktop\/session\]\s*$/,/^\s*\[/ s/^\s*idle-delay\s*=\s*(.*)$/\1/p" /etc/dconf/db/local.d/00-screensaver)
          if [[ "${currstatus}" == "uint32 900" ]]; then
            exit 0
          else
            exit 1
          fi
        else
          exit 0
        fi
      args:
        warn: false
      register: screensaver_timeout_check
      failed_when: screensaver_timeout_check.rc > 1
      changed_when: false
    - name: Correct screensaver timeout
      shell: |
        filename="/etc/dconf/db/local.d/00-screensaver"
        section="\[org\/gnome\/desktop\/session\]"
        regsection="[org/gnome/desktop/session]"
        varname="idle-delay"
        status="uint32 900"
        if [[ ! -f $filename ]] || sed -n "/^\s*${section}\s*$/q 1" $filename; then
            echo $regsection >> $filename
        fi
        sed -n -r "/^\s*${section}\s*$/,/^\s*\[/{/^\s*${varname}/q 10}" $filename
        if [[ $? -eq 10 ]]; then
            sed -i -r "/^\s*${section}\s*$/,/^\s*\[/ s/^(\s*${varname}\s*=\s*).*$/\1${status}/" $filename
        else
            sed -i "/^\s*${section}\s*$/a ${varname}=${status}" $filename
        fi
        dconf update
      args:
        warn: false
      when:
        - (screensaver_timeout_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010070

- name: "CAT II | RHEL-07-010081 | The Red Hat Enterprise Linux operating system must prevent a user from overriding the screensaver lock-delay setting for the graphical user interface."
  block:
    - name: Check for prevention of overriding timeout setting
      shell: |
        if rpm -qa|grep -qs gnome; then
          grep -qsi "/org/gnome/desktop/screensaver/lock-delay" /etc/dconf/db/local.d/locks/*
        fi
      args:
        warn: false
      register: timeout_override_check
      failed_when: timeout_override_check.rc > 2
      changed_when: false
    - name: Correct timeout override prevention
      shell: |
        echo "/org/gnome/desktop/screensaver/lock-delay" >> /etc/dconf/db/local.d/locks/session
      args:
        warn: false
      when:
        - (timeout_override_check.rc > 0)
  tags:
      - CAT-II
      - RHEL-07-010081

- name: "CAT II | RHEL-07-010082 | The Red Hat Enterprise Linux operating system must prevent a user from overriding the session idle-delay setting for the graphical user interface."
  block:
    - name: Check for prevention of overriding idle setting
      shell: |
        if rpm -qa|grep -qs gnome; then
          grep -qsi "/org/gnome/desktop/session/idle-delay" /etc/dconf/db/local.d/locks/*
        fi
      args:
        warn: false
      register: idle_override_check
      failed_when: idle_override_check.rc > 2
      changed_when: false
    - name: Correct timeout override prevention
      shell: |
        echo "/org/gnome/desktop/session/idle-delay" >> /etc/dconf/db/local.d/locks/session
      args:
        warn: false
      when:
        - (idle_override_check.rc > 0)
  tags:
      - CAT-II
      - RHEL-07-010082

- name: "CAT II | RHEL-07-010090 | The Red Hat Enterprise Linux operating system must have the screen package installed."
  block:
    - name: Check for screen or tmux installation
      shell: |
        yum list installed|grep -qs '^screen\.\|^tmux\.'
      args:
        warn: false
      register: screen_check
      ignore_errors: true
      changed_when: false
  tags:
      - CAT-II
      - RHEL-07-010090

- name: "CAT II | RHEL-07-010100 | The Red Hat Enterprise Linux operating system must initiate a session lock for the screensaver after a period of inactivity for graphical user interfaces."
  block:
    - name: Check for lock timeout
      shell: |
        if rpm -qa|grep -qs gnome; then
          currstatus=$(sed -n -r "/^\s*\[org\/gnome\/desktop\/screensaver\]\s*$/,/^\s*\[/ s/^\s*idle-activation-enabled\s*=\s*(.*)$/\1/p" /etc/dconf/db/local.d/00-screensaver)
          if [[ "${currstatus}" == "true" ]]; then
            exit 0
          else
            exit 1
          fi
        else
          exit 0
        fi
      args:
        warn: false
      register: gui_idle_activation_check
      failed_when: gui_idle_activation_check.rc > 1
      changed_when: false
    - name: Correct session lock
      shell: |
        filename="/etc/dconf/db/local.d/00-screensaver"
        section="\[org\/gnome\/desktop\/screensaver\]"
        regsection="[org/gnome/desktop/screensaver]"
        varname="idle-activation-enabled"
        if [[ ! -f $filename ]] || sed -n "/^\s*${section}\s*$/q 1" $filename; then
            echo $regsection >> $filename
        fi
        sed -n -r "/^\s*${section}\s*$/,/^\s*\[/{/^\s*${varname}/q 10}" $filename
        if [[ $? -eq 10 ]]; then
            sed -i -r "/^\s*${section}\s*$/,/^\s*\[/ s/^(\s*${varname}\s*=\s*).*$/\1true/" $filename
        else
            sed -i "/^\s*${section}\s*$/a ${varname}=true" $filename
        fi
        dconf update
      args:
        warn: false
      register: testing
      when:
        - (gui_idle_activation_check.rc > 0)
  tags:
     - CAT-II
     - RHEL-07-010100

- name: "CAT II | RHEL-07-010101 | The Red Hat Enterprise Linux operating system must prevent a user from overriding the screensaver idle-activation-enabled setting for the graphical user interface."
  block:
    - name: Check for prevention of overriding idle activation setting
      shell: |
        if rpm -qa|grep -qs gnome; then
          grep -qsi "/org/gnome/desktop/screensaver/idle-activation-enabled" /etc/dconf/db/local.d/locks/*
        fi
      args:
        warn: false
      register: idle_activation_override_check
      failed_when: idle_activation_override_check.rc > 2
      changed_when: false
    - name: Correct idle activation override prevention
      shell: |
        echo "/org/gnome/desktop/screensaver/idle-activation-enabled" >> /etc/dconf/db/local.d/locks/session
      args:
        warn: false
      when:
        - (idle_activation_override_check.rc > 0)
  tags:
      - CAT-II
      - RHEL-07-010101

- name: "CAT II | RHEL-07-010110 | The Red Hat Enterprise Linux operating system must initiate a session lock for graphical user interfaces when the screensaver is activated."
  block:
    - name: Check for screensaver delay
      shell: |
        if rpm -qa|grep -qs gnome; then
          currstatus=$(sed -n -r "/^\s*\[org\/gnome\/desktop\/screensaver\]\s*$/,/^\s*\[/ s/^\s*lock-delay\s*=\s*(.*)$/\1/p" /etc/dconf/db/local.d/00-screensaver)
          if [[ "${currstatus}" == "uint32 5" ]]; then
            exit 0
          else
            exit 1
          fi
        else
          exit 0
        fi
      args:
        warn: false
      register: screensaver_delay_check
      failed_when: screensaver_delay_check.rc > 1
      changed_when: false
    - name: Correct screensaver delay
      shell: |
        filename="/etc/dconf/db/local.d/00-screensaver"
        section="\[org\/gnome\/desktop\/screensaver\]"
        regsection="[org/gnome/desktop/screensaver]"
        varname="lock-delay"
        status="uint32 5"
        if [[ ! -f $filename ]] || sed -n "/^\s*${section}\s*$/q 1" $filename; then
            echo $regsection >> $filename
        fi
        sed -n -r "/^\s*${section}\s*$/,/^\s*\[/{/^\s*${varname}/q 10}" $filename
        if [[ $? -eq 10 ]]; then
            sed -i -r "/^\s*${section}\s*$/,/^\s*\[/ s/^(\s*${varname}\s*=\s*).*$/\1${status}/" $filename
        else
            sed -i "/^\s*${section}\s*$/a ${varname}=${status}" $filename
        fi
        dconf update
      args:
        warn: false
      when:
        - (screensaver_delay_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010110

- name: "CAT II | RHEL-07-010118 | The Red Hat Enterprise Linux operating system must be configured so that /etc/pam.d/passwd implements /etc/pam.d/system-auth when changing passwords."
  block:
    - name: Check for system-auth on password change
      shell: |
        grep -qs "^password\s\+substack\s\+system-auth" /etc/pam.d/passwd
      args:
        warn: false
      register: system_auth_passwd_check
      failed_when: system_auth_passwd_check.rc > 1
      changed_when: false
    - name: Correct system-auth on password change
      shell: |
        echo "password substack system-auth" >> /etc/pam.d/passwd
      args:
        warn: false
      when:
        - (system_auth_passwd_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010118

- name: "CAT II | RHEL-07-010119 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are established, pwquality must be used."
  block:
    - name: Check for password quality
      shell: |
        grep -qs "^password required pam_pwquality.so retry=3" /etc/pam.d/passwd
      args:
        warn: false
      register: pam_pwquality_check
      failed_when: pam_pwquality_check.rc > 1
      changed_when: false
    - name: Correct system-auth password quality
      shell: |
        if grep -qs pwquality /etc/pam.d/passwd; then
          sed -in 's/password\s\+required\s\+pam_pwquality.so\s\+retry=.*/password required pam_pwquality.so retry=3/' /etc/pam.d/passwd
        else
          echo "password required pam_pwquality.so retry=3" >> /etc/pam.d/passwd
        fi
      args:
        warn: false
      when:
        - (pam_pwquality_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010119

- name: "CAT II | RHEL-07-010120 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are established, the new password must contain at least one upper-case character."
  block:
    - name: Check for upper case password requirement
      shell: |
        grep -qs "^ucredit = -1" /etc/security/pwquality.conf
      args:
        warn: false
      register: pwquality_upper_case_check
      failed_when: pwquality_upper_case_check.rc > 1
      changed_when: false
    - name: Correct pwquality upper case requirement
      shell: |
        rule="ucredit"
        correct="-1"
        if grep -qs "^${rule}" /etc/security/pwquality.conf; then
          sed -in "s/^${rule} = .*/${rule} = ${correct}/" /etc/security/pwquality.conf
        else
          echo "${rule} = ${correct}" >> /etc/security/pwquality.conf
        fi
      args:
        warn: false
      when:
        - (pwquality_upper_case_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010120

- name: "CAT II | RHEL-07-010130 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are established, the new password must contain at least one lower-case character."
  block:
    - name: Check for lower case password requirement
      shell: |
        grep -qs "^lcredit = -1" /etc/security/pwquality.conf
      args:
        warn: false
      register: pwquality_lower_case_check
      failed_when: pwquality_lower_case_check.rc > 1
      changed_when: false
    - name: Correct pwquality lower case requirement
      shell: |
        rule="lcredit"
        correct="-1"
        if grep -qs "^${rule}" /etc/security/pwquality.conf; then
          sed -in "s/^${rule} = .*/${rule} = ${correct}/" /etc/security/pwquality.conf
        else
          echo "${rule} = ${correct}" >> /etc/security/pwquality.conf
        fi
      args:
        warn: false
      when:
        - (pwquality_lower_case_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010130

- name: "CAT II | RHEL-07-010140 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are assigned, the new password must contain at least one numeric character."
  block:
    - name: Check for numeric password requirement
      shell: |
        grep -qs "^dcredit = -1" /etc/security/pwquality.conf
      args:
        warn: false
      register: pwquality_numeric_check
      failed_when: pwquality_numeric_check.rc > 1
      changed_when: false
    - name: Correct pwquality numeric requirement
      shell: |
        rule="dcredit"
        correct="-1"
        if grep -qs "^${rule}" /etc/security/pwquality.conf; then
          sed -in "s/^${rule} = .*/${rule} = ${correct}/" /etc/security/pwquality.conf
        else
          echo "${rule} = ${correct}" >> /etc/security/pwquality.conf
        fi
      args:
        warn: false
      when:
        - (pwquality_numeric_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010140

- name: "CAT II | RHEL-07-010150 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are established, the new password must contain at least one special character."
  block:
    - name: Check for special character password requirement
      shell: |
        grep -qs "^ocredit = -1" /etc/security/pwquality.conf
      args:
        warn: false
      register: pwquality_special_check
      failed_when: pwquality_special_check.rc > 1
      changed_when: false
    - name: Correct pwquality special character requirement
      shell: |
        rule="ocredit"
        correct="-1"
        if grep -qs "^${rule}" /etc/security/pwquality.conf; then
          sed -in "s/^${rule} = .*/${rule} = ${correct}/" /etc/security/pwquality.conf
        else
          echo "${rule} = ${correct}" >> /etc/security/pwquality.conf
        fi
      args:
        warn: false
      when:
        - (pwquality_special_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010150

- name: "CAT II | RHEL-07-010160 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed a minimum of eight of the total number of characters must be changed."
  block:
    - name: Check for password length requirement
      shell: |
        grep -qs "^difok = 8" /etc/security/pwquality.conf
      args:
        warn: false
      register: pwquality_length_check
      failed_when: pwquality_length_check.rc > 1
      changed_when: false
    - name: Correct pwquality length requirement
      shell: |
        rule="difok"
        correct="8"
        if grep -qs "^${rule}" /etc/security/pwquality.conf; then
          sed -in "s/^${rule} = .*/${rule} = ${correct}/" /etc/security/pwquality.conf
        else
          echo "${rule} = ${correct}" >> /etc/security/pwquality.conf
        fi
      args:
        warn: false
      when:
        - (pwquality_length_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010160

- name: "CAT II | RHEL-07-010170 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed a minimum of four character classes must be changed."
  block:
    - name: Check for password change requirement
      shell: |
        grep -qs "^minclass = 4" /etc/security/pwquality.conf
      args:
        warn: false
      register: pwquality_change_check
      failed_when: pwquality_change_check.rc > 1
      changed_when: false
    - name: Correct pwquality change requirement
      shell: |
        rule="minclass"
        correct="4"
        if grep -qs "^${rule}" /etc/security/pwquality.conf; then
          sed -in "s/^${rule} = .*/${rule} = ${correct}/" /etc/security/pwquality.conf
        else
          echo "${rule} = ${correct}" >> /etc/security/pwquality.conf
        fi
      args:
        warn: false
      when:
        - (pwquality_change_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010170

- name: "CAT II | RHEL-07-010180 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed the number of repeating consecutive characters must not be more than three characters."
  block:
    - name: Check for password character repeat requirement
      shell: |
        grep -qs "^maxrepeat = 3" /etc/security/pwquality.conf
      args:
        warn: false
      register: pwquality_repeat_check
      failed_when: pwquality_repeat_check.rc > 1
      changed_when: false
    - name: Correct pwquality character repeat requirement
      shell: |
        rule="maxrepeat"
        correct="3"
        if grep -qs "^${rule}" /etc/security/pwquality.conf; then
          sed -in "s/^${rule} = .*/${rule} = ${correct}/" /etc/security/pwquality.conf
        else
          echo "${rule} = ${correct}" >> /etc/security/pwquality.conf
        fi
      args:
        warn: false
      when:
        - (pwquality_repeat_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010180

- name: "CAT II | RHEL-07-010190 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed the number of repeating characters of the same character class must not be more than four characters."
  block:
    - name: Check for password character class repeat requirement
      shell: |
        grep -qs "^maxclassrepeat = 4" /etc/security/pwquality.conf
      args:
        warn: false
      register: pwquality_class_repeat_check
      failed_when: pwquality_class_repeat_check.rc > 1
      changed_when: false
    - name: Correct pwquality character repeat requirement
      shell: |
        rule="maxclassrepeat"
        correct="4"
        if grep -qs "^${rule}" /etc/security/pwquality.conf; then
          sed -in "s/^${rule} = .*/${rule} = ${correct}/" /etc/security/pwquality.conf
        else
          echo "${rule} = ${correct}" >> /etc/security/pwquality.conf
        fi
      args:
        warn: false
      when:
        - (pwquality_class_repeat_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010190
