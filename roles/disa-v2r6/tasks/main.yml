---
- name: run preliminary tasks
  import_tasks: prelim.yml
  become: yes
  tags:
    - prelim_tasks

- name: "CAT I | RHEL-07-010010 | The Red Hat Enterprise Linux operating system must be configured so that the file permissions, ownership, and group membership of system files and commands match the vendor values."
  block:
    - name: Check for packages with incorrect permissions
      shell: |
        ( for i in `rpm -Va --nodeps --nosignature --nofiledigest --nosize --nomtime --nordev --nocaps --nolinkto --nouser --nogroup | egrep -i '^\.[M|U|G|.]{8}' | cut -d " " -f4,5`; do rpm -qf $i;done )
      args:
        warn: false
      register: packages_with_incorrect_permissions
      failed_when: packages_with_incorrect_permissions.rc > 1
      changed_when: false
    - name: Correct package ownership and permissions
      shell: |
        ( rpm --setugids "{{ item }}"; rpm --setperms "{{ item }}" )
      args:
        warn: false
      with_items: '{{ packages_with_incorrect_permissions.stdout_lines }}'
      when:
        - (packages_with_incorrect_permissions.stdout_lines | length > 0)
  tags:
      - CAT-I
      - RHEL-07-010010

- name: "CAT I | RHEL-07-010020 | The Red Hat Enterprise Linux operating system must be configured so that the cryptographic hash of system files and commands matches vendor values."
  block:
    - name: Check for packages with incorrect cryptographic integrity
      shell: |
        ( for i in `rpm -Va --noconfig --nolinkto --nosize --nouser --nogroup --nomtime --nomode --nodigest --nosignature | egrep -i '^..5' | cut -d " " -f4,5`; do rpm -qf $i;done )
      args:
        warn: false
      register: packages_with_incorrect_crypto
      failed_when: packages_with_incorrect_crypto.rc > 1
      changed_when: false
    - name: Correct package cryptographic integrity
      shell: |
        ( yum reinstall -y {{ item }} )
      args:
        warn: false
      register: package_fix_crypto
      failed_when: package_fix_crypto.rc > 1
      with_items: '{{ packages_with_incorrect_crypto.stdout_lines }}'
      when:
        - (packages_with_incorrect_crypto.stdout_lines | length > 0)
  tags:
      - CAT-I
      - RHEL-07-010020

- name: "CAT II | RHEL-07-010030 | The Red Hat Enterprise Linux operating system must display the Standard Mandatory DoD Notice and Consent Banner before granting local or remote access to the system via a graphical user logon."
  block:
    - name: Check if the DoD banner is shown with a graphical logon
      shell: |
        if rpm -qa|grep -qs gnome; then
          currstatus=$(sed -n -r "/^\s*\[org\/gnome\/login-screen\]\s*$/,/^\s*\[/ s/^\s*banner-message-enable\s*=\s*(.*)$/\1/p" /etc/dconf/db/local.d/01-banner-message)
          if [[ "${currstatus}" == "true" ]]; then
            exit 0
          else
            exit 1
          fi
        else
          exit 0
        fi
      args:
        warn: false
      register: gui_banner_enable_check
      failed_when: gui_banner_enable_check.rc > 1
      changed_when: false
    - name: Enable banner on graphical logon
      shell: |
        filename="/etc/dconf/db/local.d/01-banner-message"
        section="\[org\/gnome\/login-screen\]"
        regsection="[org/gnome/login-screen]"
        varname="banner-message-enable"
        if [[ ! -f $filename ]] || sed -n "/^\s*${section}\s*$/q 1" $filename; then
            echo $regsection >> $filename
        fi
        sed -n -r "/^\s*${section}\s*$/,/^\s*\[/{/^\s*${varname}/q 10}" $filename
        if [[ $? -eq 10 ]]; then
            sed -i -r "/^\s*${section}\s*$/,/^\s*\[/ s/^(\s*${varname}\s*=\s*).*$/\1true/" $filename
        else
            sed -i "/^\s*${section}\s*$/a ${varname}=true" $filename
        fi
      args:
        warn: false
      when:
        - (gui_banner_enable_check.rc > 0)
  tags:
      - CAT-II
      - RHEL-07-010030

- name: "CAT II | RHEL-07-010040 | The Red Hat Enterprise Linux operating system must display the approved Standard Mandatory DoD Notice and Consent Banner before granting local or remote access to the system via a graphical user logon."
  block:
    - name: Check for the correct DoD banner
      shell: |
        regcorrectstatus="'{{ logon_banner | regex_replace('(?s)(?<!\\n)\\n(?!(\n|$))', '') }}'"
        if rpm -qa|grep -qs gnome; then
          currstatus=$(sed -n -r "/^\s*\[org\/gnome\/login-screen\]\s*$/,/^\s*\[/ s/^\s*banner-message-text\s*=\s*(.*)$/\1/p" /etc/dconf/db/local.d/01-banner-message)
          if [[ "${currstatus}" == "${regcorrectstatus}" ]]; then
            exit 0
          else
            exit 1
          fi
        else
          exit 0
        fi
      args:
        warn: false
      register: gui_banner_correct_check
      failed_when: gui_banner_correct_check.rc > 1
      changed_when: false
    - name: Correct banner text on graphical logon
      shell: |
        filename="/etc/dconf/db/local.d/01-banner-message"
        section="\[org\/gnome\/login-screen\]"
        regsection="[org/gnome/login-screen]"
        varname="banner-message-text"
        correctstatus="'{{ logon_banner | regex_replace('(?s)(?<!\\n)\\n(?!(\n|$))', '') | regex_replace('(\(|\)|\.)', '\\\1') | regex_replace('(\\n)', '\\\\\1') }}'"
        if [[ ! -f $filename ]] || sed -n "/^\s*${section}\s*$/q 1" $filename; then
          echo "${regsection}" >> $filename
        fi
        sed -n -r "/^\s*${section}\s*$/,/^\s*\[/{/^\s*${varname}/q 10}" $filename
        if [[ $? -eq 10 ]]; then
          sed -i -r "/^\s*${section}\s*$/,/^\s*\[/ s/^(\s*${varname}\s*=\s*).*$/\1${correctstatus}/" $filename
        else
          sed -i "/^\s*${section}\s*$/a ${varname}=${correctstatus}" $filename
        fi
      args:
        warn: false
      when:
        - (gui_banner_correct_check.rc > 0)
  tags:
      - CAT-II
      - RHEL-07-010040

- name: "CAT II | RHEL-07-010050 | The Red Hat Enterprise Linux operating system must display the Standard Mandatory DoD Notice and Consent Banner before granting local or remote access to the system via a command line user logon."
  block:
    - name: Check for DoD banner for console logon
      shell: |
        correctstatus=$(echo -e "{{ logon_banner }}")
        if [[ $correctstatus == $(cat /etc/issue) ]]; then
          exit 0
        else
          exit 1
        fi
      args:
        warn: false
      register: console_banner_check
      failed_when: console_banner_check.rc > 1
      changed_when: false
    - name: Correct console logon banner
      shell: |
        echo -e "{{ logon_banner }}" > /etc/issue
      args:
        warn: false
      when:
        - (console_banner_check.rc > 0)
  tags:
     - CAT-II
     - RHEL-07-010050

- name: "CAT II | RHEL-07-010060 | The Red Hat Enterprise Linux operating system must enable a user session lock until that user re-establishes access using established identification and authentication procedures."
  block:
    - name: Check for session lock
      shell: |
        if rpm -qa|grep -qs gnome; then
          currstatus=$(sed -n -r "/^\s*\[org\/gnome\/desktop\/screensaver\]\s*$/,/^\s*\[/ s/^\s*lock-enabled\s*=\s*(.*)$/\1/p" /etc/dconf/db/local.d/00-screensaver)
          if [[ "${currstatus}" == "true" ]]; then
            exit 0
          else
            exit 1
          fi
        else
          exit 0
        fi
      args:
        warn: false
      register: gui_lock_enable_check
      failed_when: gui_lock_enable_check.rc > 1
      changed_when: false
    - name: Correct session lock
      shell: |
        filename="/etc/dconf/db/local.d/00-screensaver"
        section="\[org\/gnome\/desktop\/screensaver\]"
        regsection="[org/gnome/desktop/screensaver]"
        varname="lock-enabled"
        if [[ ! -f $filename ]] || sed -n "/^\s*${section}\s*$/q 1" $filename; then
            echo $regsection >> $filename
        fi
        sed -n -r "/^\s*${section}\s*$/,/^\s*\[/{/^\s*${varname}/q 10}" $filename
        if [[ $? -eq 10 ]]; then
            sed -i -r "/^\s*${section}\s*$/,/^\s*\[/ s/^(\s*${varname}\s*=\s*).*$/\1true/" $filename
        else
            sed -i "/^\s*${section}\s*$/a ${varname}=true" $filename
        fi
        dconf update
      args:
        warn: false
      register: testing
      when:
        - (gui_lock_enable_check.rc > 0)
  tags:
     - CAT-II
     - RHEL-07-010060

- name: "CAT II | RHEL-07-010061 | The Red Hat Enterprise Linux operating system must uniquely identify and must authenticate users using multifactor authentication via a graphical user logon."
  block:
    - name: Check for smartcard login
      shell: |
        if rpm -qa|grep -qs gnome; then
          currstatus=$(sed -n -r "/^\s*\[org\/gnome\/login-screen\]\s*$/,/^\s*\[/ s/^\s*enable-smartcard-authentication\s*=\s*(.*)$/\1/p" /etc/dconf/db/local.d/00-defaults)
          if [[ "${currstatus}" == "true" ]]; then
            exit 0
          else
            exit 1
          fi
        else
          exit 0
        fi
      args:
        warn: false
      register: smartcard_enable_check
      failed_when: smartcard_enable_check.rc > 1
      changed_when: false
    - name: Correct smartcard login
      shell: |
        filename="/etc/dconf/db/local.d/00-defaults"
        section="\[org\/gnome\/login-screen\]"
        regsection="[org/gnome/login-screen]"
        varname="enable-smartcard-authentication"
        if [[ ! -f $filename ]] || sed -n "/^\s*${section}\s*$/q 1" $filename; then
            echo $regsection >> $filename
        fi
        sed -n -r "/^\s*${section}\s*$/,/^\s*\[/{/^\s*${varname}/q 10}" $filename
        if [[ $? -eq 10 ]]; then
            sed -i -r "/^\s*${section}\s*$/,/^\s*\[/ s/^(\s*${varname}\s*=\s*).*$/\1true/" $filename
        else
            sed -i "/^\s*${section}\s*$/a ${varname}=true" $filename
        fi
        dconf update
      args:
        warn: false
      when:
        - (smartcard_enable_check.rc > 0)
  tags:
     - CAT-II
     - RHEL-07-010061

- name: "CAT II | RHEL-07-010062 | The Red Hat Enterprise Linux operating system must prevent a user from overriding the screensaver lock-enabled setting for the graphical user interface."
  block:
    - name: Check for prevention of overriding lock setting
      shell: |
        if rpm -qa|grep -qs gnome; then
          grep -qsi "/org/gnome/desktop/screensaver/lock-enabled" /etc/dconf/db/local.d/locks/*
        fi
      args:
        warn: false
      register: lock_override_check
      failed_when: lock_override_check.rc > 2
      changed_when: false
    - name: Correct lock override prevention
      shell: |
        echo "/org/gnome/desktop/screensaver/lock-enabled" >> /etc/dconf/db/local.d/locks/session
      args:
        warn: false
      when:
        - (lock_override_check.rc > 0)
  tags:
      - CAT-II
      - RHEL-07-010062

- name: "CAT II | RHEL-07-010070 | The Red Hat Enterprise Linux operating system must initiate a screensaver after a 15-minute period of inactivity for graphical user interfaces."
  block:
    - name: Check for screensaver timeout
      shell: |
        if rpm -qa|grep -qs gnome; then
          currstatus=$(sed -n -r "/^\s*\[org\/gnome\/desktop\/session\]\s*$/,/^\s*\[/ s/^\s*idle-delay\s*=\s*(.*)$/\1/p" /etc/dconf/db/local.d/00-screensaver)
          if [[ "${currstatus}" == "uint32 900" ]]; then
            exit 0
          else
            exit 1
          fi
        else
          exit 0
        fi
      args:
        warn: false
      register: screensaver_timeout_check
      failed_when: screensaver_timeout_check.rc > 1
      changed_when: false
    - name: Correct screensaver timeout
      shell: |
        filename="/etc/dconf/db/local.d/00-screensaver"
        section="\[org\/gnome\/desktop\/session\]"
        regsection="[org/gnome/desktop/session]"
        varname="idle-delay"
        status="uint32 900"
        if [[ ! -f $filename ]] || sed -n "/^\s*${section}\s*$/q 1" $filename; then
            echo $regsection >> $filename
        fi
        sed -n -r "/^\s*${section}\s*$/,/^\s*\[/{/^\s*${varname}/q 10}" $filename
        if [[ $? -eq 10 ]]; then
            sed -i -r "/^\s*${section}\s*$/,/^\s*\[/ s/^(\s*${varname}\s*=\s*).*$/\1${status}/" $filename
        else
            sed -i "/^\s*${section}\s*$/a ${varname}=${status}" $filename
        fi
        dconf update
      args:
        warn: false
      when:
        - (screensaver_timeout_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010070

- name: "CAT II | RHEL-07-010081 | The Red Hat Enterprise Linux operating system must prevent a user from overriding the screensaver lock-delay setting for the graphical user interface."
  block:
    - name: Check for prevention of overriding timeout setting
      shell: |
        if rpm -qa|grep -qs gnome; then
          grep -qsi "/org/gnome/desktop/screensaver/lock-delay" /etc/dconf/db/local.d/locks/*
        fi
      args:
        warn: false
      register: timeout_override_check
      failed_when: timeout_override_check.rc > 2
      changed_when: false
    - name: Correct timeout override prevention
      shell: |
        echo "/org/gnome/desktop/screensaver/lock-delay" >> /etc/dconf/db/local.d/locks/session
      args:
        warn: false
      when:
        - (timeout_override_check.rc > 0)
  tags:
      - CAT-II
      - RHEL-07-010081

- name: "CAT II | RHEL-07-010082 | The Red Hat Enterprise Linux operating system must prevent a user from overriding the session idle-delay setting for the graphical user interface."
  block:
    - name: Check for prevention of overriding idle setting
      shell: |
        if rpm -qa|grep -qs gnome; then
          grep -qsi "/org/gnome/desktop/session/idle-delay" /etc/dconf/db/local.d/locks/*
        fi
      args:
        warn: false
      register: idle_override_check
      failed_when: idle_override_check.rc > 2
      changed_when: false
    - name: Correct timeout override prevention
      shell: |
        echo "/org/gnome/desktop/session/idle-delay" >> /etc/dconf/db/local.d/locks/session
      args:
        warn: false
      when:
        - (idle_override_check.rc > 0)
  tags:
      - CAT-II
      - RHEL-07-010082

- name: "CAT II | RHEL-07-010090 | The Red Hat Enterprise Linux operating system must have the screen package installed."
  block:
    - name: Check for screen or tmux installation
      shell: |
        yum list installed|grep -qs '^screen\.\|^tmux\.'
      args:
        warn: false
      register: screen_check
      ignore_errors: true
      changed_when: false
  tags:
      - CAT-II
      - RHEL-07-010090

- name: "CAT II | RHEL-07-010100 | The Red Hat Enterprise Linux operating system must initiate a session lock for the screensaver after a period of inactivity for graphical user interfaces."
  block:
    - name: Check for lock timeout
      shell: |
        if rpm -qa|grep -qs gnome; then
          currstatus=$(sed -n -r "/^\s*\[org\/gnome\/desktop\/screensaver\]\s*$/,/^\s*\[/ s/^\s*idle-activation-enabled\s*=\s*(.*)$/\1/p" /etc/dconf/db/local.d/00-screensaver)
          if [[ "${currstatus}" == "true" ]]; then
            exit 0
          else
            exit 1
          fi
        else
          exit 0
        fi
      args:
        warn: false
      register: gui_idle_activation_check
      failed_when: gui_idle_activation_check.rc > 1
      changed_when: false
    - name: Correct session lock
      shell: |
        filename="/etc/dconf/db/local.d/00-screensaver"
        section="\[org\/gnome\/desktop\/screensaver\]"
        regsection="[org/gnome/desktop/screensaver]"
        varname="idle-activation-enabled"
        if [[ ! -f $filename ]] || sed -n "/^\s*${section}\s*$/q 1" $filename; then
            echo $regsection >> $filename
        fi
        sed -n -r "/^\s*${section}\s*$/,/^\s*\[/{/^\s*${varname}/q 10}" $filename
        if [[ $? -eq 10 ]]; then
            sed -i -r "/^\s*${section}\s*$/,/^\s*\[/ s/^(\s*${varname}\s*=\s*).*$/\1true/" $filename
        else
            sed -i "/^\s*${section}\s*$/a ${varname}=true" $filename
        fi
        dconf update
      args:
        warn: false
      register: testing
      when:
        - (gui_idle_activation_check.rc > 0)
  tags:
     - CAT-II
     - RHEL-07-010100

- name: "CAT II | RHEL-07-010101 | The Red Hat Enterprise Linux operating system must prevent a user from overriding the screensaver idle-activation-enabled setting for the graphical user interface."
  block:
    - name: Check for prevention of overriding idle activation setting
      shell: |
        if rpm -qa|grep -qs gnome; then
          grep -qsi "/org/gnome/desktop/screensaver/idle-activation-enabled" /etc/dconf/db/local.d/locks/*
        fi
      args:
        warn: false
      register: idle_activation_override_check
      failed_when: idle_activation_override_check.rc > 2
      changed_when: false
    - name: Correct idle activation override prevention
      shell: |
        echo "/org/gnome/desktop/screensaver/idle-activation-enabled" >> /etc/dconf/db/local.d/locks/session
      args:
        warn: false
      when:
        - (idle_activation_override_check.rc > 0)
  tags:
      - CAT-II
      - RHEL-07-010101

- name: "CAT II | RHEL-07-010110 | The Red Hat Enterprise Linux operating system must initiate a session lock for graphical user interfaces when the screensaver is activated."
  block:
    - name: Check for screensaver delay
      shell: |
        if rpm -qa|grep -qs gnome; then
          currstatus=$(sed -n -r "/^\s*\[org\/gnome\/desktop\/screensaver\]\s*$/,/^\s*\[/ s/^\s*lock-delay\s*=\s*(.*)$/\1/p" /etc/dconf/db/local.d/00-screensaver)
          if [[ "${currstatus}" == "uint32 5" ]]; then
            exit 0
          else
            exit 1
          fi
        else
          exit 0
        fi
      args:
        warn: false
      register: screensaver_delay_check
      failed_when: screensaver_delay_check.rc > 1
      changed_when: false
    - name: Correct screensaver delay
      shell: |
        filename="/etc/dconf/db/local.d/00-screensaver"
        section="\[org\/gnome\/desktop\/screensaver\]"
        regsection="[org/gnome/desktop/screensaver]"
        varname="lock-delay"
        status="uint32 5"
        if [[ ! -f $filename ]] || sed -n "/^\s*${section}\s*$/q 1" $filename; then
            echo $regsection >> $filename
        fi
        sed -n -r "/^\s*${section}\s*$/,/^\s*\[/{/^\s*${varname}/q 10}" $filename
        if [[ $? -eq 10 ]]; then
            sed -i -r "/^\s*${section}\s*$/,/^\s*\[/ s/^(\s*${varname}\s*=\s*).*$/\1${status}/" $filename
        else
            sed -i "/^\s*${section}\s*$/a ${varname}=${status}" $filename
        fi
        dconf update
      args:
        warn: false
      when:
        - (screensaver_delay_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010110

- name: "CAT II | RHEL-07-010118 | The Red Hat Enterprise Linux operating system must be configured so that /etc/pam.d/passwd implements /etc/pam.d/system-auth when changing passwords."
  block:
    - name: Check for system-auth on password change
      shell: |
        grep -qs "^password\s\+substack\s\+system-auth" /etc/pam.d/passwd
      args:
        warn: false
      register: system_auth_passwd_check
      failed_when: system_auth_passwd_check.rc > 1
      changed_when: false
    - name: Correct system-auth on password change
      shell: |
        echo "password substack system-auth" >> /etc/pam.d/passwd
      args:
        warn: false
      when:
        - (system_auth_passwd_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010118

- name: "CAT II | RHEL-07-010119 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are established, pwquality must be used."
  block:
    - name: Check for password quality
      shell: |
        grep -qs "^password required pam_pwquality.so retry=3" /etc/pam.d/passwd
      args:
        warn: false
      register: pam_pwquality_check
      failed_when: pam_pwquality_check.rc > 1
      changed_when: false
    - name: Correct system-auth password quality
      shell: |
        if grep -qs pwquality /etc/pam.d/passwd; then
          sed -in 's/password\s\+required\s\+pam_pwquality.so\s\+retry=.*/password required pam_pwquality.so retry=3/' /etc/pam.d/passwd
        else
          echo "password required pam_pwquality.so retry=3" >> /etc/pam.d/passwd
        fi
      args:
        warn: false
      when:
        - (pam_pwquality_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010119

- name: "CAT II | RHEL-07-010120 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are established, the new password must contain at least one upper-case character."
  block:
    - name: Check for upper case password requirement
      shell: |
        grep -qs "^ucredit = -1" /etc/security/pwquality.conf
      args:
        warn: false
      register: pwquality_upper_case_check
      failed_when: pwquality_upper_case_check.rc > 1
      changed_when: false
    - name: Correct pwquality upper case requirement
      shell: |
        rule="ucredit"
        correct="-1"
        if grep -qs "^${rule}" /etc/security/pwquality.conf; then
          sed -in "s/^${rule} = .*/${rule} = ${correct}/" /etc/security/pwquality.conf
        else
          echo "${rule} = ${correct}" >> /etc/security/pwquality.conf
        fi
      args:
        warn: false
      when:
        - (pwquality_upper_case_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010120

- name: "CAT II | RHEL-07-010130 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are established, the new password must contain at least one lower-case character."
  block:
    - name: Check for lower case password requirement
      shell: |
        grep -qs "^lcredit = -1" /etc/security/pwquality.conf
      args:
        warn: false
      register: pwquality_lower_case_check
      failed_when: pwquality_lower_case_check.rc > 1
      changed_when: false
    - name: Correct pwquality lower case requirement
      shell: |
        rule="lcredit"
        correct="-1"
        if grep -qs "^${rule}" /etc/security/pwquality.conf; then
          sed -in "s/^${rule} = .*/${rule} = ${correct}/" /etc/security/pwquality.conf
        else
          echo "${rule} = ${correct}" >> /etc/security/pwquality.conf
        fi
      args:
        warn: false
      when:
        - (pwquality_lower_case_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010130

- name: "CAT II | RHEL-07-010140 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are assigned, the new password must contain at least one numeric character."
  block:
    - name: Check for numeric password requirement
      shell: |
        grep -qs "^dcredit = -1" /etc/security/pwquality.conf
      args:
        warn: false
      register: pwquality_numeric_check
      failed_when: pwquality_numeric_check.rc > 1
      changed_when: false
    - name: Correct pwquality numeric requirement
      shell: |
        rule="dcredit"
        correct="-1"
        if grep -qs "^${rule}" /etc/security/pwquality.conf; then
          sed -in "s/^${rule} = .*/${rule} = ${correct}/" /etc/security/pwquality.conf
        else
          echo "${rule} = ${correct}" >> /etc/security/pwquality.conf
        fi
      args:
        warn: false
      when:
        - (pwquality_numeric_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010140

- name: "CAT II | RHEL-07-010150 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed or new passwords are established, the new password must contain at least one special character."
  block:
    - name: Check for special character password requirement
      shell: |
        grep -qs "^ocredit = -1" /etc/security/pwquality.conf
      args:
        warn: false
      register: pwquality_special_check
      failed_when: pwquality_special_check.rc > 1
      changed_when: false
    - name: Correct pwquality special character requirement
      shell: |
        rule="ocredit"
        correct="-1"
        if grep -qs "^${rule}" /etc/security/pwquality.conf; then
          sed -in "s/^${rule} = .*/${rule} = ${correct}/" /etc/security/pwquality.conf
        else
          echo "${rule} = ${correct}" >> /etc/security/pwquality.conf
        fi
      args:
        warn: false
      when:
        - (pwquality_special_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010150

- name: "CAT II | RHEL-07-010160 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed a minimum of eight of the total number of characters must be changed."
  block:
    - name: Check for password length requirement
      shell: |
        grep -qs "^difok = 8" /etc/security/pwquality.conf
      args:
        warn: false
      register: pwquality_length_check
      failed_when: pwquality_length_check.rc > 1
      changed_when: false
    - name: Correct pwquality length requirement
      shell: |
        rule="difok"
        correct="8"
        if grep -qs "^${rule}" /etc/security/pwquality.conf; then
          sed -in "s/^${rule} = .*/${rule} = ${correct}/" /etc/security/pwquality.conf
        else
          echo "${rule} = ${correct}" >> /etc/security/pwquality.conf
        fi
      args:
        warn: false
      when:
        - (pwquality_length_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010160

- name: "CAT II | RHEL-07-010170 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed a minimum of four character classes must be changed."
  block:
    - name: Check for password change requirement
      shell: |
        grep -qs "^minclass = 4" /etc/security/pwquality.conf
      args:
        warn: false
      register: pwquality_change_check
      failed_when: pwquality_change_check.rc > 1
      changed_when: false
    - name: Correct pwquality change requirement
      shell: |
        rule="minclass"
        correct="4"
        if grep -qs "^${rule}" /etc/security/pwquality.conf; then
          sed -in "s/^${rule} = .*/${rule} = ${correct}/" /etc/security/pwquality.conf
        else
          echo "${rule} = ${correct}" >> /etc/security/pwquality.conf
        fi
      args:
        warn: false
      when:
        - (pwquality_change_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010170

- name: "CAT II | RHEL-07-010180 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed the number of repeating consecutive characters must not be more than three characters."
  block:
    - name: Check for password character repeat requirement
      shell: |
        grep -qs "^maxrepeat = 3" /etc/security/pwquality.conf
      args:
        warn: false
      register: pwquality_repeat_check
      failed_when: pwquality_repeat_check.rc > 1
      changed_when: false
    - name: Correct pwquality character repeat requirement
      shell: |
        rule="maxrepeat"
        correct="3"
        if grep -qs "^${rule}" /etc/security/pwquality.conf; then
          sed -in "s/^${rule} = .*/${rule} = ${correct}/" /etc/security/pwquality.conf
        else
          echo "${rule} = ${correct}" >> /etc/security/pwquality.conf
        fi
      args:
        warn: false
      when:
        - (pwquality_repeat_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010180

- name: "CAT II | RHEL-07-010190 | The Red Hat Enterprise Linux operating system must be configured so that when passwords are changed the number of repeating characters of the same character class must not be more than four characters."
  block:
    - name: Check for password character class repeat requirement
      shell: |
        grep -qs "^maxclassrepeat = 4" /etc/security/pwquality.conf
      args:
        warn: false
      register: pwquality_class_repeat_check
      failed_when: pwquality_class_repeat_check.rc > 1
      changed_when: false
    - name: Correct pwquality character repeat requirement
      shell: |
        rule="maxclassrepeat"
        correct="4"
        if grep -qs "^${rule}" /etc/security/pwquality.conf; then
          sed -in "s/^${rule} = .*/${rule} = ${correct}/" /etc/security/pwquality.conf
        else
          echo "${rule} = ${correct}" >> /etc/security/pwquality.conf
        fi
      args:
        warn: false
      when:
        - (pwquality_class_repeat_check.rc > 0)
  tags:
    - CAT-II
    - RHEL-07-010190

- name: "CAT II | RHEL-07-010200 | The Red Hat Enterprise Linux operating system must be configured so that the PAM system service is configured to store only encrypted representations of passwords."
  block:
    - name: Check PAM to only store encrypted representations of passwords
      pamd:
        name: "{{ item[0] }}"
        state: "{{ item[1].state }}"
        type: password
        control: sufficient
        module_path: pam_unix.so
        module_arguments: "{{ item[1].args }}"
      with_nested:
        - [ 'system-auth', 'password-auth' ]
        -
          - state: args_present
            args:
              - "sha512"
          - state: args_absent
            args:
              - "md5"
              - "bigcrypt"
              - "sha256"
              - "blowfish"
  tags:
    - CAT-II
    - RHEL-07-010200

- name: "CAT II | RHEL-07-010210 | The Red Hat Enterprise Linux operating system must be configured to use the shadow file to store only encrypted representations of passwords."
  block:
    - name: Check shadow file to only store encrypted representations of passwords
      lineinfile:
        dest: /etc/login.defs
        regexp: ^#?ENCRYPT_METHOD
        line: "ENCRYPT_METHOD SHA512"
  tags:
    - CAT-II
    - RHEL-07-010210

- name: "CAT II | RHEL-07-010220 | The Red Hat Enterprise Linux operating system must be configured so that user and group account administration utilities are configured to store only encrypted representations of passwords."
  block:
    - name: Check libuser.conf to only store encrypted representations of passwords
      lineinfile:
        dest: /etc/libuser.conf
        regexp: ^#?crypt_style
        line: crypt_style = sha512
  tags:
    - CAT-II
    - RHEL-07-010220

- name: "CAT II | RHEL-07-010230 | The Red Hat Enterprise Linux operating system must be configured so that passwords for new users are restricted to a 24 hours/1 day minimum lifetime."
  block:
    - name: Check minimum password lifetime
      lineinfile:
        create: yes
        dest: /etc/login.defs
        regexp: ^#?PASS_MIN_DAYS
        line: "PASS_MIN_DAYS 1"
  tags:
    - CAT-II
    - RHEL-07-010230

- name: "CAT II | RHEL-07-010240 | The Red Hat Enterprise Linux operating system must be configured so that passwords are restricted to a 24 hours/1 day minimum lifetime."
  block:
    - name: Check minimum password lifetime for accounts
      command: "awk -F: '$1 !~ /^root$/ && $2 !~ /^[!*]/ && $4 < 1 {print $1}' /etc/shadow"
      check_mode: no
      changed_when: no
      register: minimum_password_life_check
    - name: Fix minimum password lifetime for accounts
      command: chage -m 1 {{ item }}
      with_items: "{{ minimum_password_life_check.stdout_lines }}"
  tags:
    - CAT-II
    - RHEL-07-010240

- name: "CAT II | RHEL-07-010250 | The Red Hat Enterprise Linux operating system must be configured so that passwords for new users are restricted to a 60-day maximum lifetime."
  block:
    - name: Check maximum password lifetime
      lineinfile:
        create: yes
        dest: /etc/login.defs
        regexp: ^#?PASS_MAX_DAYS
        line: "PASS_MAX_DAYS 60"
  tags:
    - CAT-II
    - RHEL-07-010250

- name: "CAT II | RHEL-07-010260 | The Red Hat Enterprise Linux operating system must be configured so that existing passwords are restricted to a 60-day maximum lifetime."
  block:
    - name: Check maximum password lifetime for accounts
      command: "awk -F: '$1 !~ /^root$/ && $2 !~ /^[!*]/ && $5 > 60 {print $1}' /etc/shadow"
      check_mode: no
      changed_when: maximum_password_life_check.stdout != ""
      register: maximum_password_life_check
    - name: Reset password to prevent locking users out
      command: chage -d '-1 day' {{ item }}
      with_items: "{{ maximum_password_life_check.stdout_lines }}"
    - name: Fix maximum password lifetime for accounts
      command: chage -M 60 {{ item }}
      with_items: "{{ maximum_password_life_check.stdout_lines }}"
  tags:
    - CAT-II
    - RHEL-07-010260

- name: "CAT II | RHEL-07-010270 | The Red Hat Enterprise Linux operating system must be configured so that passwords are prohibited from reuse for a minimum of five generations."
  block:
    - name: Ensure pam_pwhistory rule exists
      pamd:
        name: "{{ item }}"
        state: before
        type: password
        control: sufficient
        module_path: pam_unix.so
        new_type: password
        new_control: requisite
        new_module_path: pam_pwhistory.so
      with_items:
        - "system-auth"
        - "password-auth"
    - name: Check for existing password history reuse settings
      command: "grep -iE '^password\\s+requisite\\s+pam_pwhistory.so\\s+use_authtok\\s+remember=5\\s+retry=3$' /etc/pam.d/{{ item }}"
      check_mode: no
      changed_when: no
      failed_when: password_history_check.rc > 1
      register: password_history_check
      with_items:
        - "system-auth"
        - "password-auth"
    - name: Fix password history reuse settings
      pamd:
        name: "{{ item.item }}"
        state: updated
        type: password
        control: requisite
        module_path: pam_pwhistory.so
        module_arguments:
          - use_authtok
          - remember=5
          - retry=3
      with_items: "{{ password_history_check.results }}"
      when: item.rc == 1
  tags:
    - CAT-II
    - RHEL-07-010270

- name: "CAT II | RHEL-07-010280 | The Red Hat Enterprise Linux operating system must be configured so that passwords are a minimum of 15 characters in length."
  block:
    - name: check and fix pwquality minimum password length
      lineinfile:
        create: yes
        dest: /etc/security/pwquality.conf
        regexp: '^#?\s*minlen'
        line: "minlen = 15"
  tags:
    - CAT-II
    - RHEL-07-010280

- name: "CAT I | RHEL-07-010290 | The Red Hat Enterprise Linux operating system must not have accounts configured with blank or null passwords."
  block:
    - name: check for the possibility of null or blank passwords
      replace:
        dest: "{{ item }}"
        follow: true
        regexp: 'nullok ?'
      with_items:
        - /etc/pam.d/system-auth
        - /etc/pam.d/password-auth
  tags:
    - CAT-I
    - RHEL-07-010290

- name: "CAT I | RHEL-07-010300 | The Red Hat Enterprise Linux operating system must be configured so that the SSH daemon does not allow authentication using an empty password."
  block:
    - name: check for the possibility ssh with null or blank passwords
      lineinfile:
        state: present
        dest: /etc/ssh/sshd_config
        regexp: "(?i)^#?PermitEmptyPasswords"
        line: PermitEmptyPasswords no
        validate: /usr/sbin/sshd -tf %s
      notify: restart sshd
  tags:
    - CAT-I
    - RHEL-07-010300

- name: "CAT II | RHEL-07-010310 | The Red Hat Enterprise Linux operating system must disable account identifiers (individuals, groups, roles, and devices) if the password expires."
  block:
    - name: check for inactivation of user after password expires
      lineinfile:
        dest: /etc/default/useradd
        regexp: ^#?INACTIVE
        line: INACTIVE=0
  tags:
    - CAT-II
    - RHEL-07-010310

- name: |
    "CAT II | RHEL-07-010320 | The Red Hat Enterprise Linux operating system must be configured to lock accounts for a minimum of 15 minutes after three unsuccessful logon attempts within a 15-minute timeframe."
    "CAT II | RHEL-07-010330 | The Red Hat Enterprise Linux operating system must lock the associated account after three unsuccessful root logon attempts are made within a 15-minute period."
  block:
    - name: verify pam_faillock.so module exists
      pamd:
        name: "{{ item }}"
        state: before
        type: auth
        control: sufficient
        module_path: pam_unix.so
        new_type: auth
        new_control: required
        new_module_path: pam_faillock.so
      with_items:
        - "system-auth"
        - "password-auth"
    - name: check if correct rules are set for locking after 3 unsuccessful password attempts
      command: "grep -iE '^auth\\s+required\\s+pam_faillock.so\\s+preauth\\s+silent\\s+audit\\s+deny=3\\s+even_deny_root\\s+fail_interval=900\\s+unlock_time=900$' /etc/pam.d/{{ item }}"
      check_mode: no
      changed_when: no
      failed_when: password_lock_rules_check.rc > 1
      register: password_lock_rules_check
      with_items:
        - "system-auth"
        - "password-auth"
    - name: set correct rules for locking
      pamd:
        name: "{{ item.item }}"
        state: updated
        type: auth
        control: required
        module_path: pam_faillock.so
        module_arguments: "preauth silent audit deny=3 even_deny_root fail_interval=900 unlock_time=900"
      with_items: "{{ password_lock_rules_check.results }}"
      when: item.rc == 1
    - name: add default die to faillock
      pamd:
        name: "{{ item }}"
        state: before
        type: auth
        control: required
        module_path: pam_deny.so
        new_type: auth
        new_control: "[default=die]"
        new_module_path: pam_faillock.so
      with_items:
        - "system-auth"
        - "password-auth"
    - name: check if correct rules are set for authfail
      command: "grep -iE '^auth\\s+\\[default=die\\]\\s+pam_faillock.so\\s+authfail\\s+audit\\s+deny=3\\s+even_deny_root\\s+fail_interval=900\\s+unlock_time=900$' /etc/pam.d/{{ item }}"
      check_mode: no
      changed_when: no
      failed_when: authfail_check.rc > 1
      register: authfail_check
      with_items:
        - "system-auth"
        - "password-auth"
    - name: set correct rules for authfail
      pamd:
        name: "{{ item.item }}"
        state: updated
        type: auth
        control: "[default=die]"
        module_path: pam_faillock.so
        module_arguments: "authfail audit deny=3 even_deny_root fail_interval=900 unlock_time=900"
      with_items: "{{ authfail_check.results }}"
      when: item.rc == 1
    - name: make sure faillock module is required
      pamd:
        name: "{{ item }}"
        state: before
        type: account
        control: required
        module_path: pam_unix.so
        new_type: account
        new_control: required
        new_module_path: pam_faillock.so
      with_items:
        - "system-auth"
        - "password-auth"
  tags:
    - CAT-II
    - RHEL-07-010320
    - RHEL-07-010330

- name: "CAT II | RHEL-07-010340 | The Red Hat Enterprise Linux operating system must be configured so that users must provide a password for privilege escalation."
  block:
    - name: verify that password is needed for privilege escalation
      replace:
        path: "{{ item }}"
        regexp: '^([^#].*)NOPASSWD(.*)'
        replace: '\1PASSWD\2'
        validate: '/usr/sbin/visudo -cf %s'
      with_items: "{{ sudoers_files.stdout_lines }}"
  tags:
    - CAT-II
    - RHEL-07-010340

- name: "CAT II | RHEL-07-010350 | The Red Hat Enterprise Linux operating system must be configured so that users must re-authenticate for privilege escalation."
  block:
    - name: verify that reauthentication is needed for privilege escalation
      replace:
        path: "{{ item }}"
        regexp: '^([^#].*)!authenticate(.*)'
        replace: '\1authenticate\2'
        validate: '/usr/sbin/visudo -cf %s'
      with_items: "{{ sudoers_files.stdout_lines }}"
  tags:
    - CAT-II
    - RHEL-07-010350

- name: "CAT II | RHEL-07-010430 | The Red Hat Enterprise Linux operating system must be configured so that the delay between logon prompts following a failed console logon attempt is at least four seconds."
  block:
    - name: verify login delay on failed password
      lineinfile:
        dest: /etc/login.defs
        regexp: ^#?FAIL_DELAY
        line: "FAIL_DELAY 4"
  tags:
    - CAT-II
    - RHEL-07-010430

- name: "CAT I | RHEL-07-010440 | The Red Hat Enterprise Linux operating system must not allow an unattended or automatic logon to the system via a graphical user interface."
  block:
    - name: don't allow unattended graphical login
      lineinfile:
        dest: /etc/gdm/custom.conf
        regexp: (?i)automaticloginenable
        line: AutomaticLoginEnable=false
        insertafter: '\[daemon\]'
  tags:
    - CAT-I
    - RHEL-07-010440

- name: "CAT I | RHEL-07-010450 | The Red Hat Enterprise Linux operating system must not allow an unrestricted logon to the system."
  block:
    - name: don't allow unrestricted logon
      lineinfile:
        dest: /etc/gdm/custom.conf
        regexp: (?i)timedloginenable
        line: TimedLoginEnable=false
        insertafter: '\[daemon\]'
  tags:
    - CAT-I
    - RHEL-07-010450

- name: "CAT II | RHEL-07-010460 | The Red Hat Enterprise Linux operating system must not allow users to override SSH environment variables."
  block:
    - name: don't allow users to override ssh env variables
      lineinfile:
        dest: /etc/ssh/sshd_config
        regexp: "(?i)^#?PermitUserEnvironment"
        line: PermitUserEnvironment no
        validate: /usr/sbin/sshd -t -f %s
      notify: restart sshd
  tags:
    - CAT-II
    - RHEL-07-010460

- name: "CAT II | RHEL-07-010470 | The Red Hat Enterprise Linux operating system must not allow a non-certificate trusted host SSH logon to the system."
  block:
    - name: don't allow users to ssh with non-certificate trusted logon
      lineinfile:
        dest: /etc/ssh/sshd_config
        regexp: "(?i)^#?HostbasedAuthentication"
        line: HostbasedAuthentication no
        validate: /usr/sbin/sshd -t -f %s
      notify: restart sshd
  tags:
    - CAT-II
    - RHEL-07-010470

- name: |
    "CAT I | RHEL-07-010480 | Red Hat Enterprise Linux operating systems prior to version 7.2 with a Basic Input/Output System (BIOS) must require authentication upon booting into single-user and maintenance modes."
    "CAT I | RHEL-07-010482 | Red Hat Enterprise Linux operating systems version 7.2 or newer with a Basic Input/Output System (BIOS) must require authentication upon booting into single-user and maintenance modes."
    "CAT I | RHEL-07-010490 | Red Hat Enterprise Linux operating systems prior to version 7.2 using Unified Extensible Firmware Interface (UEFI) must require authentication upon booting into single-user and maintenance modes."
  block:
    - debug:
        msg:
          - "This is not applicable for UEFI Systems"
          - "This is not applicable for RHEL >7.2"
  tags:
    - CAT-I
    - RHEL-07-010480
    - RHEL-07-010482
    - RHEL-07-010490

- name: "CAT II | RHEL-07-010481 | The Red Hat Enterprise Linux operating system must require authentication upon booting into single-user and maintenance modes."
  block:
    - name: make sure authentication is required for singled-user mode
      lineinfile:
        create: true
        dest: /usr/lib/systemd/system/rescue.service
        regexp: ^#?ExecStart=
        line: ExecStart=-/bin/sh -c "/usr/sbin/sulogin; /usr/bin/systemctl --fail --no-block default"
  tags:
    - CAT-II
    - RHEL-07-010481

- name: "CAT I | RHEL-07-010491 | Red Hat Enterprise Linux operating systems version 7.2 or newer using Unified Extensible Firmware Interface (UEFI) must require authentication upon booting into single-user and maintenance modes."
  block:
    - name: verify bootloader authentication password
      lineinfile:
        path: /boot/efi/EFI/redhat/user.cfg
        create: yes
        regexp: ^GRUB2_PASSWORD=
        line: GRUB2_PASSWORD={{ bootloader_password_hash }}
      notify: make grub2 config
    - name: verify superuser accounts for bootloader
      lineinfile:
        dest: /boot/efi/EFI/redhat/grub.cfg
        create: yes
        insertafter: EOF
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
      notify: make grub2 config
      with_items:
        - regexp: ^\s*set superusers=
          line: '    set superusers="root"'
        - regexp: ^\s*export superusers
          line: '    export superusers'
  tags:
    - CAT-I
    - RHEL-07-010491

- name: "CAT I | RHEL-07-020000 | The Red Hat Enterprise Linux operating system must not have the rsh-server package installed."
  block:
    - name: make sure rsh-server is not installed
      yum:
        name: rsh-server
        state: absent
  tags:
    - CAT-I
    - RHEL-07-020000

- name: "CAT I | RHEL-07-020010 | The Red Hat Enterprise Linux operating system must not have the ypserv package installed."
  block:
    - name: make sure ypserv is not installed
      yum:
        name: ypserv
        state: absent
  tags:
    - CAT-I
    - RHEL-07-020010

#- name: "CAT II | RHEL-07-020020 | The Red Hat Enterprise Linux operating system must prevent non-privileged users from executing privileged functions to include disabling, circumventing, or altering implemented security safeguards/countermeasures."
#  block:
#    - name: check authorized users
#      command: "true"
#      changed_when: no
#      when: rhel_07_020020
#      tags:
#          - CAT-II
#          - RHEL-07-020020
#   Might need to be done manually 

- name: |
    "CAT II | RHEL-07-020030 | The Red Hat Enterprise Linux operating system must be configured so that a file integrity tool verifies the baseline operating system configuration at least weekly."
    "CAT II | RHEL-07-020040 | The Red Hat Enterprise Linux operating system must be configured so that designated personnel are notified if baseline configurations are changed in an unauthorized manner."
  block:
    - name: ensure aide installed
      shell: |
        pack=$(yum list installed aide)
        if [[ $pack -eq 0 ]]; then
          exit 0
        else
          exit 1
        fi 
      args:
        warn: false
      register: aide_installed
      failed_when: aide_installed > 1
      changed_when: false
    - name: ensure /etc/cron.daily/aide exists 
      shell: |
        file=/etc/cron.daily/aide
        if [[ -f "$file" ]]; then
          exit 0
        else
          exit 1
        fi 
      args:
        warn: false
      register: aide_cron_daily
      failed_when: aide_cron_daily > 1
      changed_when: false
    - name: ensure /etc/cron.daily/aide is set correctly
      lineinfile:
        path: /etc/cron.daily/aide
        line: '{{item}}'
      with_item:
        - '#!/bin/bash'
        - '/usr/sbin/aide --check | /bin/mail -s "$HOSTNAME - Daily aide integrity check run" root'
  tags:
    - CAT-II
    - RHEL-07-020030
    - RHEL-07-020040

- name: "CAT I | RHEL-07-020050 | The Red Hat Enterprise Linux operating system must prevent the installation of software, patches, service packs, device drivers, or operating system components from a repository without verification they have been digitally signed using a certificate that is issued by a Certificate Authority (CA) that is recognized and approved by the organization."
  block:
    - name: "set yum to verify the signature of packages"
      lineinfile:
        dest: /etc/yum.conf
        regexp: ^gpgcheck
        line: gpgcheck=1
        insertafter: '\[main\]'
  tags:
    - CAT-I
    - RHEL-07-020050

- name: "CAT I | RHEL-07-020060  | The Red Hat Enterprise Linux operating system must prevent the installation of software, patches, service packs, device drivers, or operating system components of local packages without verification they have been digitally signed using a certificate that is issued by a Certificate Authority (CA) that is recognized and approved by the organization."
  block:
    - name: "set local gpg key check"
      lineinfile:
        dest: /etc/yum.conf
        regexp: ^localpkg_gpgcheck
        line: localpkg_gpgcheck=1
        insertafter: '\[main\]'
  tags:
    - CAT-I
    - RHEL-07-020060

- name: "CAT II | RHEL-07-020100 | The Red Hat Enterprise Linux operating system must be configured to disable USB mass storage."
  lineinfile:
    dest: /etc/modprobe.d/blacklist.conf
    insertafter: "{{ item.insertafter }}"
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    create: yes
    owner: root
    group: root
    mode: "0644"
  with_items:
    - insertafter: "^#blacklist usb-storage(\\s+|$)"
      regexp: "^blacklist usb-storage(\\s+|$)"
      line: 'blacklist usb-storage'
    - insertafter: "^#install usb-storage"
      regexp: "^install usb-storage"
      line: install usb-storage /bin/true
  when: rhel_07_020100
  tags:
      - CAT-II
      - RHEL-07-020100

- name: "CAT II | RHEL-07-020110 | The Red Hat Enterprise Linux operating system must disable the file system automounter unless required."
  block:
    - name: "Check if autofs is loaded"
      shell: "systemctl show autofs | grep LoadState | cut -d = -f 2"
      register: autofs_service_status
      changed_when: no
      check_mode: no
      tags:
        - RHEL-07-020110

    - name: "Disable autofs"
      service:
        name: autofs
        enabled: no
        state: stopped
      when:
        - autofs_service_status == "loaded"
  tags:
    - RHEL-07-020110

- name: "CAT III | RHEL-07-020200 | The Red Hat Enterprise Linux operating system must remove all software components after updated versions have been installed."
  block: 
    - name: "set yum to clean up the unneeded packages"
      lineinfile:
          dest: /etc/yum.conf
          regexp: ^#?clean_requirements_on_remove
          line: clean_requirements_on_remove=1
          insertafter: '\[main\]'
  tags:
    - CAT-III
    - RHEL-07-020200

- name: |
    "CAT I | RHEL-07-20210 | The Red Hat Enterprise Linux operating system must enable SELinux."
    "CAT I | RHEL-07-20220 | The Red Hat Enterprise Linux operating system must targeted SELinux."
  selinux: 
      state: enforcing
      policy: targeted
  check_mode: "{{ ansibe_check_mode or ansible_is_chroot }}"
  tags:
    - CAT-I
    - RHEL-07-020210
    - RHEL-07-020220

- name: "CAT I | RHEL-07-20230 | The Red Hat Enterprise Linux operating system must be configured so that the x86 Ctrl-Alt-Delete key sequence is disabled on the command line."
  shell: /bin/systemctl mask ctrl-alt-del.target
  args:
    warn: false
  tags: 
    - CAT-I
    - RHEL-07-020230

- name: "CAT II | RHEL-07-020240 | The Red Hat Enterprise Linux operating system must define default permissions for all authenticated users in such a way that the user can only read and modify their own files."
  lineinfile:
    path: /etc/login.defs
    regexp: ^#?UMASK
    line: "UMASK  077"
  tags:
    - CAT-II
    - RHEL-07-020240	

#- name: "CAT I | RHEL-07-020250 | The Red Hat Enterprise Linux operating system must be a vendor supported release."
#  block:
#   name: check release version
#   shell:
#     cat /etc/redhat-release | grep 7.*
#   register: rhel_version
#   debug:
#     msg: Minumum suppported vertsion is 7.5. Your version is {{ rhel_version }}. Please upgrade
#   failed_when:
#     - rhel_version < 7.5
# tags:
#   - CAT-I
#   - RHEL-07-020250


#### WONT work offline with out a local repo on the network ########
- name: "CAT II | RHEL-07-020260 | The Red Hat Enterprise Linux operating system security patches and updates must be installed and up to date."
  yum:
      name: '*'
      state: latest
  when: rhel_07_020260
  tags:
    - CAT-II
    - RHEL-07-020260

 
- name: "CAT II | RHEL-07-020270 | The Red Hat Enterprise Linux operating system must not have unnecessary accounts."
  block:
    - name: "Check for uneccessary accounts."
      command: "grep '^{{ item }}:' /etc/passwd"
      check_mode: no
      failed_when: rhel_07_020270_audit.rc > 1
      changed_when: rhel_07_020270_audit.rc == 0
      register: rhel_07_020270_audit
      with_items: 
        - 'ftp'
        - 'games'

    - name: "remove the accounts if they exist."
      user:
          name: "{{ item }}"
          state: absent
          remove: no
      register: rhel_07_020270_patch
      with_items:
        - 'ftp'
        - 'games'

  when: rhel_07_020270
  tags:
    - CAT-II
    - RHEL-07-020270

- name: "CAT III | RHEL-07-020300 | The Red Hat Enterprise Linux operating system must be configured so that all Group Identifiers (GIDs) referenced in the /etc/passwd file are defined in the /etc/group file."
  block:
    - name: "check for no group ids"
      shell: pwck -r | grep 'no group' | awk '{ gsub("[:\47]",""); print $2}'
      changed_when: no
      failed_when: no
      check_mode: no
      register: gid_check
    - name: "display warning"
      debug:
        msg: "WARNING! {{ gid_check.stdout_lines }} do NOT have GIDs"
      when: gid_check.stdout_lines
  tags:
    - CAT-III
    - RHEL-07-020300
# - name: "CAT I | RHEL-07-020310 | The Red Hat Enterprise Linux operating system must be configured so that the root account must be the only account having unrestricted access to the system. "

- name: "CAT II | RHEL-07-020320 | The Red Hat Enterprise Linux operating system must be configured so that all files and directories have a valid owner."
  block:
    - name: "FInd all files without an owner"
      command: find "{{ item.mount }}" -
    - name: "Display all the files that need correcting"